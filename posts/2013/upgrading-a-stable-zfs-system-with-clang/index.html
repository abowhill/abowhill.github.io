<!doctype html>
<!--[if lte IE 7]>
  <meta http-equiv="refresh" content="0" url="http://browsehappy.com/" />
  <script type="text/javascript">
  /* <![CDATA[ */
  window.top.location = 'http://browsehappy.com/';
  /* ]]> */
  </script>
<![endif]-->
<!--[if IE 8]><html class="ie8"> <![endif]-->
<!--[if gt IE 8]><!--><html class="gt-ie8"><!--<![endif]-->
  
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta http-equiv="cleartype" content="on">
    <meta name="author" content="">
    <meta name="description" content="Syntaxfx">

    <title>Upgrading a -STABLE ZFS system with clang | Syntax FX</title>
    <link href="../../../stylesheets/screen.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" type="text/javascript"></script>
<script src="../../../javascripts/core.js" type="text/javascript"></script>
    <script type="text/javascript">
      WebFontConfig = {
         google: { families: [ 'IM+Fell+DW+Pica+SC::latin', 'Averia+Gruesa+Libre::latin', 'Asap::latin', 'Noto+Sans::latin' ] }
      };
      (function() {
        var wf = document.createElement('script');
        wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
          '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
        wf.type = 'text/javascript';
        wf.async = 'true';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(wf, s);
      })(); 
    </script>
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="../../../images/favicon.png" rel="icon" type="image/png" />
    <link href="../../../images/favicon.ico" rel="icon" type="image/ico" />
  </head>
  
  <body lang="en">
    <div id="container">
      <header>
        <h1>
<svg xmlns:xlink="http://www.w3.org/1999/xlink 
  width="850" height="200" viewBox="0 0 850 200" 
  preserveAspectRatio="slice">

  <a xlink:href="/" xlink:show="replace">
  <style type="text/css">
     rect:hover {fill:green}
     circle:hover {fill:green}
     text:hover {fill:green}
  </style>
     <rect width="850" height="200" 
        fill="#D6302B" fill-opacity="1.0" 
        stroke="black" stroke-width="1" />
     <circle cx="550" cy="100" r="140" 
        fill="#E85832" fill-opacity="1.0" 
        stroke="black" stroke-width="10" />
     <circle cx="550" cy="100" r="100" 
        fill="#FF7A26" fill-opacity="1.0" 
        stroke="black" stroke-width="3" />
     <circle cx="550" cy="100" r="60" 
        fill="#E8AE63" fill-opacity="1.0" 
        stroke="black" stroke-width="5" />
     <circle cx="550" cy="100" r="30" 
        fill="green" fill-opacity="1.0" 
        stroke="black" stroke-width="10" />
     <text x="0" y="195" font-size="180" text-anchor="left" 
        fill="#FFC33B" stroke="black" 
        stroke-width="3">Syntax FX</text>
  </a>
</svg>
</h1>
  <div id="intro">
     <p class="subTitle details">Tech Blog by Allan Bowhill.</p>
  </div>

        <nav class="clearfix">
          <div class="navButton button previousButton">
            <a class="previous details" href="/posts/2013/zfs-a-truly-superior-filesystem/"><i class="icon-backward left-more"></i>Earlier</a>
          </div>
          
          
            <div class="navButton button nextButton">
              <a href="/posts/2013/thermal-storage-and-active-resource-management/" class="next details">Later<i class="icon-forward right-more"></i></a>
            </div>
          
         <span class="navLinks details"><a href="http://twitter.com"><i class="icon-twitter"></i>Twitter</a><a href="/rss.rss"><i class="icon-rss"></i>RSS</a><a class="last" href="mailto:blank@blank.com"><i class="icon-envelope-alt"></i>Contact</a></span>
        </nav>
      </header>
      <article class="single">
        <h2><a href="/posts/2013/upgrading-a-stable-zfs-system-with-clang/">Upgrading a -STABLE ZFS system with clang</a></h2>
        <span class="postDetails clearfix"><time class="date details">May 21 2013</time><span class="tagLinks details">Tags: 	
	  <span class="tags"><a class="tags" href="/posts/tags/freebsd/">FreeBSD</a></span>
	
	  <span class="tags"><a class="tags" href="/posts/tags/clang/">clang</a></span>
	
	  <span class="tags"><a class="tags" href="/posts/tags/zfs/">zfs</a></span>
	</span></span>
        <p>One of the technologies I was interested in testing along with ZFS was the LLVM-based clang compiler suite on FreeBSD, which is currently under integration and slated officially to replace the gcc/g++ compiler suite in FreeBSD 10.  Right now, clang is in the 9-STABLE base system alongside gcc/g++.</p>

<p>Clang has a lot of virtues compared to gcc/g++ among which are:</p>

<ul>
  <li>Better, more informative error messages</li>
  <li>Better compliance for c++</li>
  <li>Better support for IDEs and diagnostic tools</li>
  <li>Uses less memory</li>
  <li>Has JIT support</li>
  <li>Isn’t monolithic, as is gcc/g++</li>
  <li>BSD license, so commercially viable.</li>
</ul>

<p>This is one of the things I love about FreeBSD. It’s always kept as commercially viable as possible with the BSD license. There is no reason to use open source software at work or home that has restrictive licensing. Adoption of clang is just another good reason to use FreeBSD.</p>

<p>Instructions for building the OS with clang are located at: https://wiki.freebsd.org/BuildingFreeBSDWithClang</p>

<p>This page has some useful tips, and there are a couple worth mentioning here. If you want to buildworld and your kernel with clang, you have to enable the clang suite in /etc/make.conf to replace gcc/g++:</p>

<pre class="highlight text"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div></td><td class="code">CC=clang
CXX=clang++
CPP=clang-cpp
</td></tr></tbody></table></pre><p />

<p>If you do a:  </p>

<pre class="highlight shell"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code">make buildworld kernel 
</td></tr></tbody></table></pre><p />

<p>with the default command line options, it should work just fine. Nothing further to do.</p>

<p>However, if you’re feeling cautious and want to test the kernel itself first, run the following from /usr/src:</p>

<pre class="highlight shell"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code">make kernel <span class="nv">KERNCONF</span><span class="o">=</span>GENERIC <span class="nv">INSTKERNNAME</span><span class="o">=</span>clang
</td></tr></tbody></table></pre><p />

<p>The line above builds a GENERIC kernel called clang, but places it into a separate directory along with its modules in /boot. This way, you leave your previous gcc kernel in place, yet can test the clang kernel easily with some intervention at the boot loader.</p>

<p>If you go this route, when you reboot, drop to the bootloader (option 2) and enter the following to change the module path to boot into the clang kernel:</p>

<pre class="highlight text"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div></td><td class="code">set module_path=/boot/clang
boot clang
</td></tr></tbody></table></pre><p />

<p>If the kernel panics, there is no need to do so yourself. Just reboot into the old gcc /boot/kernel without intervention, and it will load by default. If you moved or destroyed the old kernel instead, and the option isn’t available you can always opt to load /boot/kernel.old and its modules instead from the boot loader.</p>

<p>However, a clang boot will likely work, and the system should boot and enable you to make kernel buildworld, installworld, etc. This worked fine for me, but on one machine there was a kernel panic bootstrapping the system due to (probably) module installation paths, which was fairly easy to address.</p>

<p>For some reason, the clang kernel was loading but clang modules were not. I decided to reinstall the kernel again, leaving off the KERNCONF=GENERIC build option:</p>
<p />

<pre class="highlight text"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code">make reinstallkernel
</td></tr></tbody></table></pre><p />

<p>Which did the trick.</p>

<p>Once booted, a subsequent view of dmesg will show which compiler was used to build the kernel.</p>

<p>I will be experimenting with this ZFS clang build setup for a little while, and note some of the issues I come across in following posts, but so far, ZFS and clang kernel/OS are performing nicely on my little underpowered Toshiba NB 205 netbook!</p>

<blockquote>
  <p>Note: Rebuilding the kernel/OS worked fine on my server machine - an old Celeron 1G box.</p>
</blockquote>

      </article>
      <footer class="footer clearfix">
	<div class="contact">
		<p class="details">Contact me, if that's what you want.</p>
	</div>
	<div class="links">
		<ul class="clearfix">
			<li class="details"><a href="/posts/2013.html">Archive</a></li>
			<li class="details"><a href="/rss.rss">RSS</a></li>
			<li class="details"><a href="mailto:allanbowhill@yahoo.com">Contact</a></li>
		</ul>
	</div>
</footer>

    </div>
  </body>
</html>
