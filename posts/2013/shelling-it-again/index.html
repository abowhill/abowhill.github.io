<!doctype html>
<!--[if lte IE 7]>
  <meta http-equiv="refresh" content="0" url="http://browsehappy.com/" />
  <script type="text/javascript">
  /* <![CDATA[ */
  window.top.location = 'http://browsehappy.com/';
  /* ]]> */
  </script>
<![endif]-->
<!--[if IE 8]><html class="ie8"> <![endif]-->
<!--[if gt IE 8]><!--><html class="gt-ie8"><!--<![endif]-->
  
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta http-equiv="cleartype" content="on">
    <meta name="author" content="">
    <meta name="description" content="Syntaxfx">

    <title>Shelling it again | Syntax FX</title>
    <link href="../../../stylesheets/screen.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" type="text/javascript"></script>
<script src="../../../javascripts/core.js" type="text/javascript"></script>
    <script type="text/javascript">
      WebFontConfig = {
         google: { families: [ 'IM+Fell+DW+Pica+SC::latin', 'Averia+Gruesa+Libre::latin', 'Asap::latin', 'Noto+Sans::latin' ] }
      };
      (function() {
        var wf = document.createElement('script');
        wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
          '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
        wf.type = 'text/javascript';
        wf.async = 'true';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(wf, s);
      })(); 
    </script>
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="../../../images/favicon.png" rel="icon" type="image/png" />
    <link href="../../../images/favicon.ico" rel="icon" type="image/ico" />
  </head>
  
  <body lang="en">
    <div id="container">
      <header>
        <h1>
<svg xmlns:xlink="http://www.w3.org/1999/xlink 
  width="850" height="200" viewBox="0 0 850 200" 
  preserveAspectRatio="slice">

  <a xlink:href="/" xlink:show="replace">
  <style type="text/css">
     rect:hover {fill:green}
     circle:hover {fill:green}
     text:hover {fill:green}
  </style>
     <rect width="850" height="200" 
        fill="#D6302B" fill-opacity="1.0" 
        stroke="black" stroke-width="1" />
     <circle cx="550" cy="100" r="140" 
        fill="#E85832" fill-opacity="1.0" 
        stroke="black" stroke-width="10" />
     <circle cx="550" cy="100" r="100" 
        fill="#FF7A26" fill-opacity="1.0" 
        stroke="black" stroke-width="3" />
     <circle cx="550" cy="100" r="60" 
        fill="#E8AE63" fill-opacity="1.0" 
        stroke="black" stroke-width="5" />
     <circle cx="550" cy="100" r="30" 
        fill="green" fill-opacity="1.0" 
        stroke="black" stroke-width="10" />
     <text x="0" y="195" font-size="180" text-anchor="left" 
        fill="#FFC33B" stroke="black" 
        stroke-width="3">Syntax FX</text>
  </a>
</svg>
</h1>
  <div id="intro">
     <p class="subTitle details">Tech Blog by Allan Bowhill.</p>
  </div>

        <nav class="clearfix">
          <div class="navButton button previousButton">
            <a class="previous details" href="/posts/2013/ruby-rvm-redux-rvm-on-windows-too/"><i class="icon-backward left-more"></i>Earlier</a>
          </div>
          
          
            <div class="navButton button nextButton">
              <a href="/posts/2013/a-notation-for-functional-design-with-binary-outcomes/" class="next details">Later<i class="icon-forward right-more"></i></a>
            </div>
          
         <span class="navLinks details"><a href="http://twitter.com"><i class="icon-twitter"></i>Twitter</a><a href="/rss.rss"><i class="icon-rss"></i>RSS</a><a class="last" href="mailto:blank@blank.com"><i class="icon-envelope-alt"></i>Contact</a></span>
        </nav>
      </header>
      <article class="single">
        <h2><a href="/posts/2013/shelling-it-again/">Shelling it again</a></h2>
        <span class="postDetails clearfix"><time class="date details">Mar 23 2013</time><span class="tagLinks details">Tags: 	
	  <span class="tags"><a class="tags" href="/posts/tags/shell/">shell</a></span>
	
	  <span class="tags"><a class="tags" href="/posts/tags/scripts/">scripts</a></span>
	</span></span>
        <p>Sadly again, I find myself using the punishing /bin/sh to script tasks in FreeBSD. And again, I am reminded how painful and time-consuming it can be to do some of the simplest things.</p>

<p>One of the first things you should realize is that sh is not Bash. It is Bash featureless ancestor - a kind of pygmy caveman. It is smaller, faster, and somewhat harder to work with. It has nearly meaningless error-messages.</p>

<p>One thing I am absorbing about the language this shell speaks is that variables take several forms.</p>

<p><strong>Left-hand side name:</strong></p>

<pre class="highlight text"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code">dinosaur=&quot;Dino&quot;
</td></tr></tbody></table></pre><p>In this form, a variable is recieving a value. </p>

<p><strong>Right-hand side name:</strong></p>

<pre class="highlight text"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code">animal=$dinosaur
</td></tr></tbody></table></pre><p>In tools form, $dinosaur is a variable is being used for something. Here, assignment to another variable.</p>

<p><strong>Formal name:</strong></p>

<pre class="highlight text"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code">${dinosaur}
</td></tr></tbody></table></pre><p>The same as $dinosaur, but in this form you can change the entire tone and context of the name, like <strong>_$(dinosaur)!!_</strong>, which will translate to <strong>_dino!!_</strong>. </p>

<p><strong>Verbing-name</strong></p>

<pre class="highlight text"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code">animal=$(dinosaur)
</td></tr></tbody></table></pre><p>Although it looks like it, this is not a variable, but a command to do something in a shell. In this case, we are trying to call a program name “dinosaur” in the operating system. If dinosaur exists and replies, <strong>$animal</strong> will hold the response.</p>

<p><strong>Deep verbing-name:</strong></p>

<pre class="highlight text"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code">$($dinosaur)
</td></tr></tbody></table></pre><p>Just like the verbing name, but specificlly calling the program “Dino” in the operating system.</p>

<p><strong>Subshell verbing-name:</strong></p>

<pre class="highlight text"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code">`dinosaur`
</td></tr></tbody></table></pre><p>Here, we are calling a subshell to try to run the program “dinosaur”.</p>

<p>And so on. It’s worth noting the shell has two parts:</p>

<ul>
  <li>The enviroment storage area</li>
  <li>The shell storage area</li>
</ul>

<p>The environment contains all the variables that have been exported to semi-protected storage, and will persist throughout the shell’s various operating modes and subshells. However, the shell’s unprotected variable storage area can be assigned-to without using the export command.</p>

<p>This is important in shell programming, because when you assign some value to a variable, names and values are stored in this unprotected environment. Unlike programming languages, the shell has no other way to store names and values. </p>

<p>When you run a script from the prompt like this:</p>

<pre class="highlight shell"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code"><span class="gp">&gt; </span>scriptname.sh
</td></tr></tbody></table></pre>
<p>It runs in a subshell, and all the unprotected storage it used is destroyed when it returns, but the semi-protected environment is transferred to the subshell. When you run a script like this:</p>

<pre class="highlight shell"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code"><span class="gp">&gt; </span><span class="nb">source </span>scriptname.sh
</td></tr></tbody></table></pre>
<p>it is not run in a subshell, and all the variables and values the script created are retained in the unprotected environment. This can have ramifications between subsequent runs if you don’t reset your variables in your script.</p>

<p>It is also true that all variables are global by default in a script. So although these variables are often destroyed after the script has completed running in a subshell, you can get into trouble by assuming names are localized inside the body of the script itself.</p>

<p>Shell scripts do have callable functions, but they can’t return values other than exit codes. If you want return values, you have to assign a global variable the role of holding a return value from all functions, and clear that variable at the beginning of every function. This is called defensive programming.</p>

<p>So the deal is, you can have functions effectively return two values: the status code (an integer, usually indicating failure or success) and a string containing some result data. </p>

<p>Below, is a function to take a pathname as a string and and clean out duplicate slashes from it, returning it as a string. It also returns a status code, on whether the clean path was found (0) or not found (1). If the function was handed an empty input string, it returns (2) and if some other error occurs, it returns that too.</p>

<p>The test driver for the function basically calls the function and parses the results. The input to the test driver are various unclean paths.</p>

<p>I think it shows functions are viable in sh scripts, which can serve as an advantage to programming these things. But getting the syntax and behavior correct is actually quite hard to. </p>

<p>Using Perl or Ruby, something like this can be done in minutes. Doing it in shell can take a lot longer, especially because it’s a blind man’s walk of trial and error, especially if you’re used to more sophisticated languages where true is true and false is false; not having to call external programs for regular expressions, or are unaccustomed to built-in variables disappearing if you don’t capture them right away.</p>

<pre class="highlight shell"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div><div class="lineno">4</div><div class="lineno">5</div><div class="lineno">6</div><div class="lineno">7</div><div class="lineno">8</div><div class="lineno">9</div><div class="lineno">10</div><div class="lineno">11</div><div class="lineno">12</div><div class="lineno">13</div><div class="lineno">14</div><div class="lineno">15</div><div class="lineno">16</div><div class="lineno">17</div><div class="lineno">18</div><div class="lineno">19</div><div class="lineno">20</div><div class="lineno">21</div><div class="lineno">22</div><div class="lineno">23</div><div class="lineno">24</div><div class="lineno">25</div><div class="lineno">26</div><div class="lineno">27</div><div class="lineno">28</div><div class="lineno">29</div><div class="lineno">30</div><div class="lineno">31</div></td><td class="code"><span class="nb">unset </span>ret
 
fixpath<span class="o">()</span>
   <span class="o">{</span>
   <span class="nb">unset </span>ret
   <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>2
   <span class="nv">ret</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">1</span><span class="k">}</span> | sed -r <span class="s1">&#39;s/\/+/\//g&#39;</span><span class="sb">`</span>
   <span class="o">[</span> -e <span class="s2">&quot;</span><span class="nv">$ret</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0 <span class="o">||</span> <span class="k">return </span>1
   <span class="o">}</span>
 
testfixpath<span class="o">()</span>
   <span class="o">{</span>
   <span class="nb">unset </span>ret
   <span class="nv">path</span><span class="o">=</span><span class="nv">$1</span>
   <span class="nb">echo</span> <span class="s2">&quot;Input path: </span><span class="nv">$path</span><span class="s2">&quot;</span>
   fixpath <span class="s2">&quot;</span><span class="nv">$path</span><span class="s2">&quot;</span>
   <span class="nv">err</span><span class="o">=</span><span class="nv">$?</span>
   <span class="nb">echo</span> <span class="s2">&quot;Output path: </span><span class="k">${</span><span class="nv">ret</span><span class="k">}</span><span class="s2">&quot;</span>
 
   <span class="k">case</span> <span class="nv">$err</span> <span class="k">in
     </span>0<span class="p">)</span>   <span class="nb">echo</span> <span class="s2">&quot;Return code </span><span class="nv">$err</span><span class="s2"> (true) </span><span class="k">${</span><span class="nv">ret</span><span class="k">}</span><span class="s2"> exists.&quot;</span><span class="p">;;</span>
     1<span class="p">)</span>   <span class="nb">echo</span> <span class="s2">&quot;Return code </span><span class="nv">$err</span><span class="s2"> (false) </span><span class="k">${</span><span class="nv">ret</span><span class="k">}</span><span class="s2"> does not exist.&quot;</span><span class="p">;;</span>
     2<span class="p">)</span>   <span class="nb">echo</span> <span class="s2">&quot;Return code </span><span class="nv">$err</span><span class="s2"> (error) missing argument </span><span class="k">${</span><span class="nv">ret</span><span class="k">}</span><span class="s2">&quot;</span><span class="p">;;</span>
     <span class="k">*</span><span class="p">)</span>   <span class="nb">echo</span> <span class="s2">&quot;Return code </span><span class="nv">$err</span><span class="s2"> (undefined error) </span><span class="k">${</span><span class="nv">ret</span><span class="k">}</span><span class="s2">&quot;</span><span class="p">;;</span>
   <span class="k">esac</span>
   <span class="nb">echo</span> <span class="s2">&quot;---&quot;</span>
   <span class="o">}</span>
 
testfixpath <span class="s2">&quot;/foobar/me/////me///me//you.txt&quot;</span>
testfixpath <span class="s2">&quot;/usr/local/////sbin///&quot;</span>
testfixpath <span class="s2">&quot;&quot;</span>
</td></tr></tbody></table></pre>
      </article>
      <footer class="footer clearfix">
	<div class="contact">
		<p class="details">Contact me, if that's what you want.</p>
	</div>
	<div class="links">
		<ul class="clearfix">
			<li class="details"><a href="/posts/2013.html">Archive</a></li>
			<li class="details"><a href="/rss.rss">RSS</a></li>
			<li class="details"><a href="mailto:allanbowhill@yahoo.com">Contact</a></li>
		</ul>
	</div>
</footer>

    </div>
  </body>
</html>
