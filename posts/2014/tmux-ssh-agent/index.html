<!doctype html>
<!--[if lte IE 7]>
  <meta http-equiv="refresh" content="0" url="http://browsehappy.com/" />
  <script type="text/javascript">
  /* <![CDATA[ */
  window.top.location = 'http://browsehappy.com/';
  /* ]]> */
  </script>
<![endif]-->
<!--[if IE 8]><html class="ie8"> <![endif]-->
<!--[if gt IE 8]><!--><html class="gt-ie8"><!--<![endif]-->
  
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta http-equiv="cleartype" content="on">
    <meta name="author" content="">
    <meta name="description" content="Syntaxfx">

    <title>Preserving ssh-agent credentials in Tmux | Syntax FX</title>
    <link href="../../../stylesheets/screen.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" type="text/javascript"></script>
<script src="../../../javascripts/core.js" type="text/javascript"></script>
    <script type="text/javascript">
      WebFontConfig = {
         google: { families: [ 'IM+Fell+DW+Pica+SC::latin', 'Averia+Gruesa+Libre::latin', 'Asap::latin', 'Noto+Sans::latin' ] }
      };
      (function() {
        var wf = document.createElement('script');
        wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
          '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
        wf.type = 'text/javascript';
        wf.async = 'true';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(wf, s);
      })(); 
    </script>
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="../../../images/favicon.png" rel="icon" type="image/png" />
    <link href="../../../images/favicon.ico" rel="icon" type="image/ico" />
<!-- MathJax Library -->
<script type="text/javascript" src="https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG"> </script>
  </head>
  
  <body lang="en">
    <div id="container">
      <header>
        <h1>
<svg xmlns:xlink="http://www.w3.org/1999/xlink 
  width="850" height="200" viewBox="0 0 850 200" 
  preserveAspectRatio="slice">

  <a xlink:href="/" xlink:show="replace">
  <style type="text/css">
     rect:hover {fill:green}
     circle:hover {fill:green}
     text:hover {fill:green}
  </style>
     <rect width="850" height="200" 
        fill="#D6302B" fill-opacity="1.0" 
        stroke="black" stroke-width="1" />
     <circle cx="550" cy="100" r="140" 
        fill="#E85832" fill-opacity="1.0" 
        stroke="black" stroke-width="10" />
     <circle cx="550" cy="100" r="100" 
        fill="#FF7A26" fill-opacity="1.0" 
        stroke="black" stroke-width="3" />
     <circle cx="550" cy="100" r="60" 
        fill="#E8AE63" fill-opacity="1.0" 
        stroke="black" stroke-width="5" />
     <circle cx="550" cy="100" r="30" 
        fill="green" fill-opacity="1.0" 
        stroke="black" stroke-width="10" />
     <text x="0" y="195" font-size="180" text-anchor="left" 
        fill="#FFC33B" stroke="black" 
        stroke-width="3">Syntax FX</text>
  </a>
</svg>
</h1>
  <div id="intro">
     <p class="subTitle details">Tech Blog by Allan Bowhill.</p>
  </div>

        <nav class="clearfix">
          <div class="navButton button previousButton">
            <a class="previous details" href="/posts/2014/meta-munchkins/"><i class="icon-backward left-more"></i>Earlier</a>
          </div>
          
          
            <div class="navButton button nextButton">
              <a href="/posts/2013/index.html" class="next details">Archive<i class="icon-reorder right-more"></i></a>
            </div>
          
         <span class="navLinks details"><a href="http://twitter.com"><i class="icon-twitter"></i>Twitter</a><a href="/rss.rss"><i class="icon-rss"></i>RSS</a><a class="last" href="mailto:blank@blank.com"><i class="icon-envelope-alt"></i>Contact</a></span>
        </nav>
      </header>
      <article class="single">
        <h2><a href="/posts/2014/tmux-ssh-agent/">Preserving ssh-agent credentials in Tmux</a></h2>
        <span class="postDetails clearfix"><time class="date details">Mar 31 2014</time><span class="tagLinks details">Tags: 	
	  <span class="tags"><a class="tags" href="/posts/tags/tmux/">tmux</a></span>
	
	  <span class="tags"><a class="tags" href="/posts/tags/freebsd/">freebsd</a></span>
	
	  <span class="tags"><a class="tags" href="/posts/tags/ssh/">ssh</a></span>
	</span></span>
        <p>Tmux is a terminal multiplexor. It lets you manage many simultaneous running shells from a single ssh protected console window. It has a flexible windowing scheme that gives you multiple groups of resizable panels and stateful protection of your terminal sessions wether you wilfully or accidentally detach a working session. It’s a must-have for a console ssh user, but there can be problems with maintaining <strong>ssh-agent</strong> (passwordless) connections after logout, which requires some setup tactics to preserve.</p>

<h3 id="ssh-practice">SSH practice</h3>
<hr />
<p>Typically, with ssh, you’d take a copy of your public key on Host A, and drop it into <code>~./ssh/authorized_keys</code> on <em>Hosts B, C, and D</em>. On <em>Host A</em>, you’d start the agent, authenticate once, then gain secure access to hosts B, C, and D without entering a password. </p>

<p>The agent invokation might go something like this:</p>

<pre class="highlight shell"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div><div class="lineno">4</div><div class="lineno">5</div></td><td class="code">HOST_A &gt; ssh-agent bash 
<span class="o">(</span>subshell entered<span class="o">)</span>
HOST_A &gt; ssh-add 
Enter passphrase <span class="k">for</span> /home/myuser/.ssh/id_rsa: &lt;you enter passphrase&gt;
Identity added: /home/myuser/.ssh/id_rsa <span class="o">(</span>/home/myuser/.ssh/id_rsa<span class="o">)</span>
</td></tr></tbody></table></pre><p />

<p>Then doing:</p>

<pre class="highlight shell"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div></td><td class="code">HOST_A &gt; ssh host_b
<span class="o">(</span>passwordless login<span class="o">)</span>
HOST_B &gt; 
</td></tr></tbody></table></pre><p />

<p>Will get you into <em>Host B</em> with no passphrase.</p>

<p>A lot of stateful work is held in tmux shells. Typically you may have a dozen or more of these passwordless ssh sessions running, all connected to various hosts and to different projects. What you do not want to have happen is to lose the agent authentication for all these connections when you detach and reattach a tmux session, something often done when switching from a workstation to a laptop, for instance. Losing ssh passwordless connections is a huge headache to deal with.</p>

<p>Depending on how you call tmux directly will determine if you lose passwordless authentication on disconnect. If you start tmux with </p>

<pre class="highlight shell"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code"><span class="gp">HOST_A&gt; </span>ssh-agent tmux   &lt;-- big mistake!
</td></tr></tbody></table></pre><p />

<p>Everything will run as expected until you disconnect. Then suddenly when you reconnect, all your subshells will have lost their authentication, and will fallback to manual passphrase entry if they are reconnected to an ssh host.  The tactic I want to show you is how to use indirection to preserve all your agent sessions in tmux, so that detaching and reattaching will leave everything unaffected.</p>

<h3 id="the-configuration-road-map">The configuration road-map</h3>
<hr />
<p>Essentially, you start a top-level tmux session without ssh agent. Let’s call this session the <strong>CONTROL</strong> session. The <strong>CONTROL</strong> session is a wrapper that prevents ssh from being informed about connection information. Within <strong>CONTROL</strong>, you create windows, each establishing a single ssh-agent tmux subsession to be used generally with a single remote host. Within each of these nested tmux ssh sessions, you can add windows and panels. Each window and panel will inherit passwordless authentication for free. When you detach or disconnect, all the capabilities of each terminal are preserved, no matter what machine you login with or what network you’re using.</p>

<p>I will try to use the following terms to describe tmux by it’s stucture in this scenario. It may not agree with the docs. Basically a tmux process consists of one or more sessions, which consist of one or more windows, which consist of one or more panels.</p>

<pre class="highlight shell"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div></td><td class="code">tmux --&gt; sessions --&gt; windows --&gt; panels
         named        named       shells
</td></tr></tbody></table></pre><p />

<p>As shown in the diagram above, sessions and windows can be named. These names display on a status bar at the bottom of the tmux screen if the following configuration file is used in <code>~/.tmux.conf</code>:</p>

<pre class="highlight conf"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div><div class="lineno">4</div><div class="lineno">5</div><div class="lineno">6</div><div class="lineno">7</div><div class="lineno">8</div><div class="lineno">9</div><div class="lineno">10</div><div class="lineno">11</div><div class="lineno">12</div><div class="lineno">13</div></td><td class="code"><span class="c"># set putty window &gt; translation is-8859-1
# export TERM=screen-256color
# http://blog.gmane.org/gmane.comp.terminal-emulators.tmux.user/month=20101101
# http://blog.ijun.org/2011/09/install-tmux-on-freebsd-tutorial-step.html
</span>
<span class="n">set</span> -<span class="n">g</span> <span class="n">default</span>-<span class="n">terminal</span> <span class="n">screen</span>-<span class="m">256</span><span class="n">color</span>
<span class="n">set</span> -<span class="n">g</span> <span class="n">status</span>-<span class="n">bg</span> <span class="n">red</span>
<span class="n">set</span> -<span class="n">g</span> <span class="n">status</span>-<span class="n">fg</span> <span class="n">green</span>
<span class="n">set</span> -<span class="n">g</span> <span class="n">status</span>-<span class="n">right</span> <span class="s1">&#39;#(sysctl vm.loadavg)&#39;</span>
<span class="n">setw</span> -<span class="n">g</span> <span class="n">window</span>-<span class="n">status</span>-<span class="n">current</span>-<span class="n">attr</span> <span class="n">underscore</span>
<span class="n">bind</span> <span class="n">r</span> <span class="n">source</span>-<span class="n">file</span> ~/.<span class="n">tmux</span>.<span class="n">conf</span>
<span class="n">setw</span> -<span class="n">g</span> <span class="n">utf8</span> <span class="n">on</span>
<span class="n">set</span> -<span class="n">g</span> <span class="n">status</span>-<span class="n">utf8</span> <span class="n">on</span>
</td></tr></tbody></table></pre><p />

<p>Overall we aim to have some kind of structure similar to the following diagram, with a <strong>CONTROL</strong>, <strong>LOCAL</strong> and <strong>WWW</strong> sessions as examples.</p>

<p><strong>CONTROL</strong> is the wrapper session, and not used for anything other than housing the other sessions.  <strong>LOCAL</strong> is a graph of terminals being used on the main host. <strong>WWW</strong> is the set of terminals on a web machine connected by ssh agent passwordless logins.</p>

<pre class="highlight conf"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div><div class="lineno">4</div><div class="lineno">5</div><div class="lineno">6</div><div class="lineno">7</div><div class="lineno">8</div><div class="lineno">9</div><div class="lineno">10</div><div class="lineno">11</div><div class="lineno">12</div><div class="lineno">13</div><div class="lineno">14</div><div class="lineno">15</div><div class="lineno">16</div><div class="lineno">17</div><div class="lineno">18</div><div class="lineno">19</div><div class="lineno">20</div><div class="lineno">21</div><div class="lineno">22</div><div class="lineno">23</div><div class="lineno">24</div><div class="lineno">25</div><div class="lineno">26</div><div class="lineno">27</div><div class="lineno">28</div><div class="lineno">29</div><div class="lineno">30</div><div class="lineno">31</div><div class="lineno">32</div><div class="lineno">33</div><div class="lineno">34</div><div class="lineno">35</div><div class="lineno">36</div><div class="lineno">37</div></td><td class="code">           <span class="n">tmux</span>
             |
	     + <span class="n">CONTROL</span> <span class="n">session</span>
	          |
	          +---&gt; <span class="n">CONTROL</span> <span class="n">MASTER</span>
                  |
	          +---&gt; <span class="n">LOCAL</span> <span class="n">MASTER</span>  (<span class="n">ssh</span>-<span class="n">agent</span>)
		  |     <span class="n">LOCAL</span>
		  |        |
                  |        +---&gt;<span class="n">LOCAL</span> (<span class="n">Window</span> <span class="m">1</span>)
                  |        |   |
                  |        |   +---&gt; <span class="n">Panel</span> <span class="m">1</span> (<span class="n">shell</span>)
                  |        |   |
                  |        |   +---&gt; <span class="n">Panel</span> <span class="m">2</span> (<span class="n">shell</span>)
                  |        |   |
                  |        |   +---&gt; <span class="n">Panel</span> <span class="m">3</span> (<span class="n">shell</span>)
                  |        |
                  |        +---&gt;<span class="n">LOCAL</span> (<span class="n">Window</span> <span class="m">2</span>)
                  |            |
                  |            +---&gt; <span class="n">Panel</span> <span class="m">1</span> (<span class="n">shell</span>)
                  |            |
                  |            +---&gt; <span class="n">Panel</span> <span class="m">2</span> (<span class="n">shell</span>)
                  |
	          +---&gt; <span class="n">WWW</span> <span class="n">MASTER</span> (<span class="n">ssh</span>-<span class="n">agent</span>)
		  |     <span class="n">WWW</span> 
		  |        |
                  |        +---&gt;<span class="n">WWW</span> 
                  |        |   |
                  |        |   +---&gt; <span class="n">Panel</span> <span class="m">1</span> (<span class="n">shell</span>)
                  |        |  
                  |        |
                  |        +---&gt;<span class="n">WWW</span> 
                  |            |
                  |            +---&gt; <span class="n">Panel</span> <span class="m">1</span> (<span class="n">shell</span>)
                  |            |
                  |            +---&gt; <span class="n">Panel</span> <span class="m">2</span> (<span class="n">shell</span>)
		  (<span class="n">ad</span> <span class="n">nauseum</span>...)
</td></tr></tbody></table></pre><p />

<p>Switching between sessions on this tree is accomplished by <code>CTRL-B s</code>, while switching between each session’s windows is done with <code>CTRL-B w</code>. <code>CTRL-B &lt;arrow&gt;</code> moves focus between panels in a window. You do all your work inside panels each containing a shell prompt.  Panels can be resized, even to look like windows.  <code>CTRL-B ALT &lt;arrow&gt;</code> resizes a panel by one character in the arrow-direction, and <code>CTRL-B z</code> toggles maximize/minimize on a panel to full-screen.</p>

<p>To start our setup we need to issue the tmux command <code>&gt; tmux</code>. This will create a session and a window with a shell and a status bar.</p>

<p><img src="../../../images/1-tmux-login-first.PNG" alt="tmux shell" /></p>

<p>We need to rename the session to <strong>CONTROL</strong> by issuing <code>CTRL-B $</code> editing at the prompt on the status bar. The current sesssion name always appears on the far left, contained within square brackets.</p>

<p><img src="../../../images/2-tmux-rename-session.PNG" alt="tmux rename session" /></p>

<p>We also need to rename the window (window zero) to <strong>CONTROL-MASTER</strong> by issuing <code>CTRL-B ,</code> and overwriting the text there with <strong>“CONTROL-MASTER”</strong>. The current window in tmux is always underlined on the status bar.</p>

<p><img src="../../../images/3-tmux-rename-window.PNG" alt="tmux rename window" /></p>

<p>The <strong>CONTROL</strong> session should not really be used for anything. It’s just a wrapper to hold the leaders of other sessions. After we have named it, it’s best to block input to this window with some kind of system status tracker like top, systat or tail -f /var/log/messages.</p>

<p><img src="../../../images/4-tmux-block-control-master.PNG" alt="block control-master window" /></p>

<p>To create our first ssh-agent authenticated session: <strong>LOCAL</strong>, we open a new window in the <strong>CONTROL</strong> session by typing <code>CTRL-B c</code>. <strong>LOCAL</strong> will just be used for shells spawned on the localhost, but we still want the capability of quick passwordless access to our other machines from here. We need to name this window <strong>LOCAL-MASTER</strong> via <code>CTRL-B ,</code>. When we finish setup in this window, it will become the top-level authenticator for all other working <strong>LOCAL</strong> ssh connections.</p>

<p>Next, we setup the ssh-authenticator for <strong>LOCAL</strong> session by:</p>

<pre class="highlight shell"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code"><span class="nb">unset </span>TMUX; ssh-agent tmux
</td></tr></tbody></table></pre><p />

<p>We have to unset the TMUX environment variable to unlock the safety switch placed in by the TMUX authors. Then, when the nested tmux shell boots, you will see two status bars at the bottom of the screen:</p>

<p><img src="../../../images/5-tmux-local-ssh.PNG" alt="nested tmux" /></p>

<p>At this point, type <strong>ssh-add</strong> and enter your passphrase.</p>

<p>Note that this can be quite confusing to look at. We are still in the <strong>CONTROL</strong> session, but have established a new, unnamed session for <strong>LOCAL</strong>. It’s important to remember a few things about being in the <strong>CONTROL</strong> session.</p>

<ul>
  <li>
    <p>What you see in the <strong>CONTROL</strong> session window will vary later on, so you can’t trust its contents.</p>
  </li>
  <li>
    <p>The bottom status bar in this session is the only relevant one, and belongs to <strong>CONTROL</strong>. This means we are in the <strong>CONTROL</strong> session context.</p>
  </li>
  <li>
    <p>This <strong>CONTROL</strong> window X is shared in the LOCAL session context as Window zero.</p>
  </li>
</ul>

<p>We are still in the <strong>CONTROL</strong> session at this point, but have setup an anonymous session for <strong>LOCAL</strong>. Now let’s change context to <strong>LOCAL</strong> by using <code>CTRL-B s</code> (the session menu) and selecting the session that is <strong>not</strong> <strong>CONTROL</strong>.</p>

<p><img src="../../../images/6-session-context-control-to-local.PNG" alt="switch to unnamed context" /></p>

<p>Note the status bar is back to one, but the window contents did not change. It is a shared window. To complete bootstrapping this session we need to:</p>

<p>a. Use <code>CTRL-B ,</code> to change the window name to <strong>LOCAL</strong>.
b. Use <code>CTRL-B $</code> to change the session name to <strong>LOCAL</strong>.
c. Start a copy of something like top, systat or tail -f /var/log/messages to block input.</p>

<p><img src="../../../images/7-finish-local-context.PNG" alt="finish local context setup" /></p>

<p>To establish sessions with other machines, we simply repeat the steps above:</p>

<ol>
  <li><code>CTRL-B s</code> to select the <strong>CONTROL</strong> session.</li>
  <li><code>CTRL-B c</code> to open a new <strong>CONTROL</strong> window.</li>
  <li><code>CTRL-B ,</code> to change the window name to <strong>«session_name»-MASTER</strong></li>
  <li><code>unset TMUX; ssh-agent tmux</code></li>
  <li><code>ssh-add &lt;enter passphrase&gt;</code></li>
  <li><code>CTRL-B s</code> to select the context of new anonymous session we just made.</li>
  <li><code>CTRL-B ,</code> to change the window name to «session_name»</li>
  <li><code>CTRL-B $</code> to change the session name to «session_name»</li>
  <li>Login to the associated remote host for this session, and run top, systat, or tail -f to block input.</li>
</ol>

<p>Once you have all your sessions established, you can switch to a given session, and open any number of windows with <code>CTRL-B c</code> and panels with <code>CTRL-B &amp;</code> (to the right) or <code>CTRL-"</code> (below). All of them will have their <strong>ssh-agent</strong> sessions and runtime preserved between sessions.</p>

<p><img src="../../../images/8-www-complete.PNG" alt="open windows and panels" /></p>

      </article>
      <footer class="footer clearfix">
	<div class="contact">
		<p class="details">Contact me, if that's what you want.</p>
	</div>
	<div class="links">
		<ul class="clearfix">
			<li class="details"><a href="/posts/2013.html">Archive</a></li>
			<li class="details"><a href="/rss.rss">RSS</a></li>
			<li class="details"><a href="mailto:allanbowhill@yahoo.com">Contact</a></li>
		</ul>
	</div>
</footer>

    </div>
  </body>
</html>
